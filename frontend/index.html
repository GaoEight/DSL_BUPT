<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>DSL 测试</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f0f2f5;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding-top: 50px;
    }
    .container {
      width: 350px;
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 15px rgba(0,0,0,0.1);
    }
    h2 { text-align: center; margin-bottom: 20px; }
    input, select, button {
      width: 100%;
      padding: 10px;
      margin: 5px 0;
      border-radius: 5px;
      border: 1px solid #ccc;
      box-sizing: border-box;
    }
    button { background: #1890ff; color: white; border: none; cursor: pointer; }
    button:hover { background: #40a9ff; }
    .link { color: #1890ff; cursor: pointer; text-decoration: underline; }
    #chat-log {
      border: 1px solid #ccc;
      height: 300px;
      overflow-y: auto;
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 5px;
      background: #fafafa;
    }
    .msg { margin:5px 0; padding:8px 12px; border-radius:15px; max-width:80%; display:inline-block;}
    .msg.user { background:#1890ff;color:white;align-self:flex-end;text-align:right;margin-left:auto;}
    .msg.bot { background:#e6e6e6;color:black;align-self:flex-start;text-align:left;margin-right:auto;}
    #user-info { text-align:center; margin-bottom:10px; font-weight:bold; }
  </style>
</head>
<body>
  <div class="container">
    <!-- 登录界面 -->
    <div id="login-page">
      <h2>登录</h2>
      <input id="login-name" placeholder="用户名">
      <input id="login-pass" type="password" placeholder="密码">
      <select id="login-role">
        <option value="student">学生</option>
        <option value="teacher">老师</option>
      </select>
      <button onclick="login()">登录</button>
      <p>没有账号？<span class="link" onclick="showRegister()">注册</span></p>
      <div id="login-msg" style="color:red;"></div>
    </div>

    <!-- 注册界面 -->
    <div id="register-page" style="display:none;">
      <h2>注册</h2>
      <input id="reg-name" placeholder="用户名">
      <input id="reg-pass" type="password" placeholder="密码">
      <select id="reg-role">
        <option value="student">学生</option>
        <option value="teacher">老师</option>
      </select>
      <button onclick="register()">注册</button>
      <p>已有账号？<span class="link" onclick="showLogin()">返回登录</span></p>
      <div id="register-msg" style="color:red"></div>
    </div>

    <!-- 聊天界面 -->
    <div id="chat-page" style="display:none;">
      <div id="user-info"></div>
      <div id="chat-log"></div>
      <input id="chat-input" placeholder="输入消息" onkeydown="if(event.key==='Enter'){sendMessage();}">
      <button onclick="sendMessage()">发送</button>
    </div>
  </div>

  <script>
    let token = "";
    let userRole = "";
    let userName = "";

    function showLogin(){
      document.getElementById('login-page').style.display = 'block';
      document.getElementById('register-page').style.display = 'none';
      document.getElementById('chat-page').style.display = 'none';
    }

    function showRegister(){
      document.getElementById('login-page').style.display = 'none';
      document.getElementById('register-page').style.display = 'block';
      document.getElementById('chat-page').style.display = 'none';
    }

    function showChat(){
      document.getElementById('login-page').style.display = 'none';
      document.getElementById('register-page').style.display = 'none';
      document.getElementById('chat-page').style.display = 'block';
      document.getElementById('user-info').innerText = `${userName} (${userRole})`;
    }

    async function login(){
      userName = document.getElementById('login-name').value;
      const pass = document.getElementById('login-pass').value;
      userRole = document.getElementById('login-role').value;

      const res = await fetch('/api/login',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({name:userName, pass, role:userRole})
      });
      const data = await res.json();
      if(data.success){
        token = "fake-token"; 
        showChat();
      } else {
        document.getElementById('login-msg').innerText = data.message;
      }
    }

    async function register(){
      const name = document.getElementById('reg-name').value;
      const pass = document.getElementById('reg-pass').value;
      const role = document.getElementById('reg-role').value;

      const res = await fetch('/api/login',{  // 伪后端接口都一样
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({name, pass, role})
      });
      const data = await res.json();
      if(data.success){
        alert("注册成功，请登录");
        showLogin();
      } else {
        document.getElementById('register-msg').innerText = data.message;
      }
    }

    async function sendMessage(){
      const input = document.getElementById('chat-input');
      const log = document.getElementById('chat-log');
      const msg = input.value.trim();
      if(!msg) return;
      input.value = "";

      // 用户消息
      const userDiv = document.createElement('div');
      userDiv.className = 'msg user';
      userDiv.textContent = msg;
      log.appendChild(userDiv);
      log.scrollTop = log.scrollHeight;

      // 发送到后端
      const res = await fetch('/api/chat',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({msg, token})
      });
      const data = await res.json();

      // 后端消息
      const botDiv = document.createElement('div');
      botDiv.className = 'msg bot';
      botDiv.textContent = data.reply;
      log.appendChild(botDiv);
      log.scrollTop = log.scrollHeight;
    }
  </script>
</body>
</html>
